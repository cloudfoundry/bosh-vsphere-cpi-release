  - name: <%= e "lifecycle-#{pool}" %>
    serial: true
    plan:
    - in_parallel:
      - get: source-ci
        tags: [nimbus]
      - get: bosh-cpi-src
        tags: [nimbus]
        trigger: true
        passed: [unit-test]
      - get: vcpi-main-image
      - get: stemcell
        tags: [nimbus]
      - put: environment
        tags: [nimbus]
        resource: <%= e "pool-#{pool}" %>
        timeout: 4h
        params:
          action: create
          lifetime: <%= 4 * 60 * 60 %>
          timeout: <%= 4 * 60 * 60 %>
          resource: testbed-lock
    - task: test
      tags: [nimbus]
      file: source-ci/ci/tasks/run-lifecycle.yml
      image: vcpi-main-image
      privileged: true
      params:
<% pool.params.each do |k, v| -%>
        <%= e k %>: <%= e v %>
<% end -%>
      on_failure:
        put: <%= e "pool-#{pool}" %>
        tags: [nimbus]
        params: { action: extend, lifetime: <%= 24 * 60 * 60 %>, resource: environment }
      on_success:
        put: <%= e "pool-#{pool}" %>
        tags: [nimbus]
        params : { action: release, resource: environment }

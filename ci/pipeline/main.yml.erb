jobs:
  - name: unit-tests
    plan:
    - aggregate:
      - get: source-ci
      - get: bosh-cpi-src
        trigger: true
    - aggregate:
      - task: unit-tests
        file: source-ci/ci/tasks/cpi-networking-unit-test.yml


  - name: lock-v6.5-nsxt21-mikhail-ci
    plan:
      - aggregate:
        - get: source-ci
        - get: bosh-cpi-src
          passed: [unit-tests]
          trigger: true
      - do:
        - put: environment
          resource: v6.5-nsxt21-mikhail-ci
          params: {acquire: true}
        - task: extend-lease-6.5
          file: source-ci/ci/tasks/extend-lease.yml
          params:
            DBCUSER: {{dbc_user}}
            DBCHOST: {{dbc_host}}
            DBC_SSH_KEY: {{dbc_key}}
          on_failure:
            put: v6.5-nsxt21-mikhail-ci
            params : {release: environment}
        attempts: 4

  - name: integration-tests
    plan:
    - aggregate:
      - get: source-ci
      - get: bosh-cpi-src
        passed: [lock-v6.5-nsxt21-mikhail-ci]
        trigger: true
      - get: environment
        passed: [lock-v6.5-nsxt21-mikhail-ci]
        resource: v6.5-nsxt21-mikhail-ci
        trigger: true
      - get: stemcell
    - task: integration-tests
      file: source-ci/ci/tasks/cpi-networking-integration-test.yml
      params:
        BOSH_VSPHERE_EDGE_CLUSTER_ID: c78e185c-799b-407f-90b9-c34bc08caf57
        BOSH_VSPHERE_T0_ROUTER_ID: fa47375e-8696-436b-b266-241e89e72b05
        BOSH_VSPHERE_TRANSPORT_ZONE_ID: 7011302e-1ee9-4074-842f-ef88a41ec507

  - name: unlock-v6.5-nsxt21-mikhail-ci
    plan:
      - get: v6.5-nsxt21-mikhail-ci
        passed: [integration-tests]
        trigger: true
      - put: v6.5-nsxt21-mikhail-ci
        params : {release: v6.5-nsxt21-mikhail-ci}

resources:
#  - name: pool-6.0-NSXV
#    type: pool
#    source:
#      uri:          git@github.com:ktchen14/vcpi-pool.git
#      branch:       master
#      pool:         v6.0-nsxv
#      private_key:  {{vcpi-pool_deployment_key}}
#  - name: pool-6.5
#    type: pool
#    source:
#      uri:          git@github.com:ktchen14/vcpi-pool.git
#      branch:       master
#      pool:         v6.5
#      private_key:  {{vcpi-pool_deployment_key}}
#  - name: pool-5.5
#    type: pool
#    source:
#      uri:          git@github.com:ktchen14/vcpi-pool.git
#      branch:       master
#      pool:         v5.5
#      private_key:  {{vcpi-pool_deployment_key}}
#  - name: pool-6.0
#    type: pool
#    source:
#      uri:          git@github.com:ktchen14/vcpi-pool.git
#      branch:       master
#      pool:         v6.0
#      private_key:  {{vcpi-pool_deployment_key}}
#  - name: pool-6.7
#    type: pool
#    source:
#      uri:          git@github.com:ktchen14/vcpi-pool.git
#      branch:       master
#      pool:         v6.7
#      private_key:  {{vcpi-pool_deployment_key}}
#  - name: bosh-cpi-artifacts
#    type: s3
#    source:
#      regexp:            bosh-vsphere-cpi-([\d\.]+)\.tgz
#      bucket:            {{s3_vsphere_cpi_bucket}}
#      access_key_id:     {{s3_vsphere_cpi_blobwriter_access_key}}
#      secret_access_key: {{s3_vsphere_cpi_blobwriter_secret_key}}
  - name: v6.5-nsxt21-mikhail-ci
    type: pool
    source:
      uri:          git@github.com:ktchen14/vcpi-pool.git
      branch:       master
      pool:         v6.5-nsxt21-mikhail-ci
      private_key:  {{vcpi-pool_deployment_key}}
  - name: source-ci
    type: git
    source:
      uri:         git@github.com:cloudfoundry-incubator/bosh-vsphere-cpi-release.git
      branch:      {{vcpi_branch}}
      private_key: {{github_deployment_key__bosh-vsphere-cpi-release}}
      paths:       [ci]
  - name: bosh-cpi-src
    type: git
    source:
      uri:         git@github.com:cloudfoundry-incubator/bosh-vsphere-cpi-release.git
      branch:      {{vcpi_branch}}
      private_key: {{github_deployment_key__bosh-vsphere-cpi-release}}
      ignore_paths: [ci]
  - name: stemcell
    type: bosh-io-stemcell
    source:
      name: bosh-vsphere-esxi-ubuntu-trusty-go_agent

#  - name: version-semver
#    type: semver
#    source:
#      key:               current-version
#      bucket:            {{s3_vsphere_cpi_bucket}}
#      access_key_id:     {{s3_vsphere_cpi_blobwriter_access_key}}
#      secret_access_key: {{s3_vsphere_cpi_blobwriter_secret_key}}
#  - name: release-version-semver
#    type: semver
#    source:
#      key:               release-current-version
#      bucket:            {{s3_vsphere_cpi_bucket}}
#      access_key_id:     {{s3_vsphere_cpi_blobwriter_access_key}}
#      secret_access_key: {{s3_vsphere_cpi_blobwriter_secret_key}}
#  - name: bosh-deployment
#    type: git
#    source:
#      uri: https://github.com/cloudfoundry/bosh-deployment
#      branch: master
#  - name: certification
#    type: git
#    source:
#      uri: https://github.com/cloudfoundry-incubator/bosh-cpi-certification
#      branch: master
#  - name: old-bosh-release
#    type: s3
#    source:
#      bucket: bosh-cpi-certification-fixtures
#      regexp: precompiled-bosh-(255.8)-on-ubuntu-3232.3.tgz
#      region_name: us-east-1
#  - name: old-stemcell
#    type: s3
#    source:
#      bucket: bosh-cpi-certification-fixtures
#      regexp: bosh-stemcell-(3232.3)-vsphere-esxi-ubuntu-trusty-go_agent.tgz
#      region_name: us-east-1
#  - name: bosh-cli
#    type: s3
#    source:
#      regexp: bosh-cli-([0-9.]+)-linux-amd64
#      bucket: bosh-cli-artifacts
#      region_name: us-east-1
#  - name: bats
#    type: git
#    source:
#      uri: https://github.com/cloudfoundry/bosh-acceptance-tests.git
#      branch: master
#  - name: tracker-output
#    type: tracker
#    source:
#      token: {{tracker_api_token}}
#      project_id: {{tracker_project_id}}
#      tracker_url: https://www.pivotaltracker.com
#
#groups:
#
#- name: Complete-View
#  jobs:
#  - unit-test
#  - build-candidate
#  - bats
#  - lock-bats
#  - unlock-bats
#  - lock-6.5
#  - lifecycle-6.5
#  - unlock-6.5
#  - lock-6.7
#  - lifecycle-6.7
#  - unlock-6.7
#  - lifecycle-6.0
#  - lock-6.0
#  - unlock-6.0
#  - promote-candidate
#  - lock-6.5-NSXV
#  - lifecycle-6.5-NSXV
#  - unlock-6.5-NSXV
#  - lifecycle-6.0-NSXV
#  - lock-6.0-NSXV
#  - unlock-6.0-NSXV
#  - lifecycle-5.5
#  - lock-5.5
#  - unlock-5.5
#
#
#- name: Delivery
#  jobs:
#  - lifecycle-6.5
#  - lifecycle-6.0
#  - lifecycle-5.5
#  - lifecycle-6.7
#  - lifecycle-6.5-NSXV
#  - lifecycle-6.0-NSXV
#  - bats
#  - delivery
#
#- name: bats
#  jobs:
#  - unit-test
#  - bats
#  - lock-bats
#  - unlock-bats
#
#
#- name: v6.5
#  jobs:
#  - unit-test
#  - lock-6.5
#  - lifecycle-6.5
#  - unlock-6.5
#  - lock-6.5-NSXV
#  - lifecycle-6.5-NSXV
#  - unlock-6.5-NSXV
#
#- name: v6.0
#  jobs:
#  - unit-test
#  - lifecycle-6.0
#  - lock-6.0
#  - unlock-6.0
#  - lifecycle-6.0-NSXV
#  - lock-6.0-NSXV
#  - unlock-6.0-NSXV
#
#- name: v5.5
#  jobs:
#  - unit-test
#  - lifecycle-5.5
#  - lock-5.5
#  - unlock-5.5
#
#- name: v6.7
#  jobs:
#  - unit-test
#  - lifecycle-6.7
#  - lock-6.7
#  - unlock-6.7
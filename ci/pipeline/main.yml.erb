jobs:
  - name: unit-tests
    plan:
    - aggregate:
      - get: source-ci
      - get: bosh-cpi-src
    - aggregate:
      - task: unit-tests
        file: source-ci/ci/tasks/cpi-networking-unit-test.yml


  - name: lock-v6.5-nsxt21-mikhail-ci
    plan:
      - aggregate:
        - get: source-ci
        - get: bosh-cpi-src
          passed: [unit-tests]
          trigger: true
      - do:
        - put: environment
          resource: v6.5-nsxt21-mikhail-ci
          params: {acquire: true}
        - task: extend-lease-6.5
          file: source-ci/ci/tasks/extend-lease.yml
          params:
            DBCUSER: {{dbc_user}}
            DBCHOST: {{dbc_host}}
            DBC_SSH_KEY: {{dbc_key}}
          on_failure:
            put: v6.5-nsxt21-mikhail-ci
            params : {release: environment}
        attempts: 4

  - name: integration-tests
    plan:
    - aggregate:
      - get: source-ci
      - get: bosh-cpi-src
        passed: [lock-v6.5-nsxt21-mikhail-ci]
        trigger: true
      - get: environment
        passed: [lock-v6.5-nsxt21-mikhail-ci]
        resource: v6.5-nsxt21-mikhail-ci
        trigger: true
      - get: stemcell
    - task: integration-tests
      file: source-ci/ci/tasks/cpi-networking-integration-test.yml
      params:
        BOSH_VSPHERE_EDGE_CLUSTER_ID: d8b8ad76-53b0-45fb-b851-5eef27a33c72
        BOSH_VSPHERE_T0_ROUTER_ID: b72c2fc1-3ec8-4337-baff-84085ebf69f7
        BOSH_VSPHERE_TRANSPORT_ZONE_ID: 89f166b6-b15c-4a23-9861-3699a58ec9ad
      on_failure:
        put: v6.5-nsxt21-mikhail-ci
        params : {release: environment}

  - name: unlock-v6.5-nsxt21-mikhail-ci
    plan:
      - get: v6.5-nsxt21-mikhail-ci
        passed: [integration-tests]
        trigger: true
      - put: v6.5-nsxt21-mikhail-ci
        params : {release: v6.5-nsxt21-mikhail-ci}

  - name: release-and-publish
    plan:
    - aggregate:
      - get: source-ci
      - get: bosh-cpi-src
        passed: [integration-tests]
    - task: create-bosh-release
      file: source-ci/ci/tasks/cpi-networking-release-and-publish.yml
    - put: vsphere-cpi-networking-release
      params:
        file: bosh-vsphere-cpi-networking-release/bosh-vsphere-cpi-networking-release.tgz
        acl: public-read

resources:
  - name: vsphere-cpi-networking-release
    type: s3
    source:
      versioned_file:    bosh-vsphere-cpi-networking.tgz
      bucket:            bosh-vsphere-cpi-networking-release
      access_key_id:     {{certification__bucket_access_key}}
      secret_access_key: {{certification__bucket_secret_key}}
  - name: v6.5-nsxt21-mikhail-ci
    type: pool
    source:
      uri:          git@github.com:ktchen14/vcpi-pool.git
      branch:       master
      pool:         v6.5-nsxt21-mikhail-ci
      private_key:  {{vcpi-pool_deployment_key}}
  - name: source-ci
    type: git
    source:
      uri:         git@github.com:cloudfoundry-incubator/bosh-vsphere-cpi-release.git
      branch:      {{vcpi_branch}}
      private_key: {{github_deployment_key__bosh-vsphere-cpi-release}}
      paths:       [ci]
  - name: bosh-cpi-src
    type: git
    source:
      uri:         git@github.com:cloudfoundry-incubator/bosh-vsphere-cpi-release.git
      branch:      {{vcpi_branch}}
      private_key: {{github_deployment_key__bosh-vsphere-cpi-release}}
      ignore_paths: [ci]
  - name: stemcell
    type: bosh-io-stemcell
    source:
      name: bosh-vsphere-esxi-ubuntu-trusty-go_agent

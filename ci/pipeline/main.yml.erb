jobs:
  - name: unit-test
    plan:
    - aggregate:
      - get: source-ci
      - get: bosh-cpi-src
        trigger: true
    - aggregate:
      - task: test-pyvmomi_to_ruby
        file: source-ci/ci/tasks/test-pyvmomi_to_ruby.yml
      - task: unit-test
        file: source-ci/ci/tasks/unit-test.yml

<% each_pool do |pool| -%>
<%= render('partition', pool: pool) %>
<% end -%>

  - name: release-and-publish
    plan:
    - aggregate:
      - get: source-ci
      - get: bosh-cpi-src
        passed: [lifecycle-6.5-NSXT21]
    - task: create-bosh-release
      file: source-ci/ci/tasks/cpi-networking-release-and-publish.yml
    - put: vsphere-cpi-networking-release
      params:
        file: bosh-vsphere-cpi-networking-release/bosh-vsphere-cpi-networking-release.tgz
        acl: public-read


resource_types:
  - name: slack-notification
    type: docker-image
    source:
      repository: cfcommunity/slack-notification-resource

resources:
  - name: pool-6.5-NSXV
    type: pool
    source:
      uri:          git@github.com:ktchen14/vcpi-pool.git
      branch:       master
      pool:         v6.5-nsxv
      private_key:  {{vcpi-pool_deployment_key}}
  - name: pool-6.5-NSXT21
    type: pool
    source:
      uri:          git@github.com:ktchen14/vcpi-pool.git
      branch:       master
      pool:         v6.5-nsxt21
      private_key:  {{vcpi-pool_deployment_key}}
  - name: pool-6.0-NSXV
    type: pool
    source:
      uri:          git@github.com:ktchen14/vcpi-pool.git
      branch:       master
      pool:         v6.0-nsxv
      private_key:  {{vcpi-pool_deployment_key}}
  - name: pool-6.5
    type: pool
    source:
      uri:          git@github.com:ktchen14/vcpi-pool.git
      branch:       master
      pool:         v6.5
      private_key:  {{vcpi-pool_deployment_key}}
  - name: pool-5.5
    type: pool
    source:
      uri:          git@github.com:ktchen14/vcpi-pool.git
      branch:       master
      pool:         v5.5
      private_key:  {{vcpi-pool_deployment_key}}
  - name: pool-6.0
    type: pool
    source:
      uri:          git@github.com:ktchen14/vcpi-pool.git
      branch:       master
      pool:         v6.0
      private_key:  {{vcpi-pool_deployment_key}}
  - name: pool-6.7
    type: pool
    source:
      uri:          git@github.com:ktchen14/vcpi-pool.git
      branch:       master
      pool:         v6.7
      private_key:  {{vcpi-pool_deployment_key}}
  - name: vsphere-cpi-networking-release
    type: s3
    source:
      versioned_file:    bosh-vsphere-cpi-networking.tgz
      bucket:            bosh-vsphere-cpi-networking-release
      access_key_id:     {{certification__bucket_access_key}}
      secret_access_key: {{certification__bucket_secret_key}}
  - name: source-ci
    type: git
    source:
      uri:         git@github.com:cloudfoundry-incubator/bosh-vsphere-cpi-release.git
      branch:      {{vcpi_branch}}
      private_key: {{github_deployment_key__bosh-vsphere-cpi-release}}
      paths:       [ci]
  - name: bosh-cpi-src
    type: git
    source:
      uri:         git@github.com:cloudfoundry-incubator/bosh-vsphere-cpi-release.git
      branch:      {{vcpi_branch}}
      private_key: {{github_deployment_key__bosh-vsphere-cpi-release}}
      ignore_paths: [ci]
  - name: stemcell
    type: bosh-io-stemcell
    source:
      name: bosh-vsphere-esxi-ubuntu-trusty-go_agent

groups:

- name: Complete-View
  jobs:
  - unit-test
  - lock-6.5
  - lifecycle-6.5
  - unlock-6.5
  - lock-6.7
  - lifecycle-6.7
  - unlock-6.7
  - lifecycle-6.0
  - lock-6.0
  - unlock-6.0
  - lock-6.5-NSXV
  - lifecycle-6.5-NSXV
  - unlock-6.5-NSXV
  - lock-6.5-NSXT21
  - lifecycle-6.5-NSXT21
  - unlock-6.5-NSXT21
  - lifecycle-6.0-NSXV
  - lock-6.0-NSXV
  - unlock-6.0-NSXV
  - lifecycle-5.5
  - lock-5.5
  - unlock-5.5
  - release-and-publish


- name: Delivery
  jobs:
  - lifecycle-6.5
  - lifecycle-6.0
  - lifecycle-5.5
  - lifecycle-6.7
  - lifecycle-6.5-NSXV
  - lifecycle-6.5-NSXT21
  - lifecycle-6.0-NSXV

- name: v6.5
  jobs:
  - unit-test
  - lock-6.5
  - lifecycle-6.5
  - unlock-6.5
  - lock-6.5-NSXV
  - lifecycle-6.5-NSXV
  - unlock-6.5-NSXV
  - lock-6.5-NSXT21
  - lifecycle-6.5-NSXT21
  - unlock-6.5-NSXT21

- name: v6.0
  jobs:
  - unit-test
  - lifecycle-6.0
  - lock-6.0
  - unlock-6.0
  - lifecycle-6.0-NSXV
  - lock-6.0-NSXV
  - unlock-6.0-NSXV

- name: v5.5
  jobs:
  - unit-test
  - lifecycle-5.5
  - lock-5.5
  - unlock-5.5

- name: v6.7
  jobs:
  - unit-test
  - lifecycle-6.7
  - lock-6.7
  - unlock-6.7
#!/bin/bash

set -e

BOSH_PACKAGES_DIR=${BOSH_PACKAGES_DIR:-/var/vcap/packages}
BOSH_JOBS_DIR=${BOSH_JOBS_DIR:-/var/vcap/jobs}

<% require 'shellwords' %>

<% if_p('env.http_proxy') do |http_proxy| %>
  export HTTP_PROXY="<%= http_proxy.shellescape %>"
  export http_proxy="<%= http_proxy.shellescape %>"
<% end %>

<% if_p('env.https_proxy') do |https_proxy| %>
  export HTTPS_PROXY="<%= https_proxy.shellescape %>"
  export https_proxy="<%= https_proxy.shellescape %>"
<% end %>

<% if_p('env.no_proxy') do |no_proxy| %>
  export NO_PROXY="<%= no_proxy.shellescape %>"
  export no_proxy="<%= no_proxy.shellescape %>"
<% end %>

<% if_p('vcenter.connection_options.ca_cert') do %>
  export BOSH_CA_CERT_FILE=$BOSH_JOBS_DIR/vsphere_cpi/config/cacert.pem
<% end %>

export PATH=$BOSH_PACKAGES_DIR/ruby-2.4-r3/bin:$BOSH_PACKAGES_DIR/iso9660wrap/bin:$PATH
export HOME=~

export BUNDLE_GEMFILE=$BOSH_PACKAGES_DIR/vsphere_cpi/Gemfile
bundle_cmd="${BOSH_PACKAGES_DIR}/ruby-2.4-r3/bin/bundle"

exec $bundle_cmd exec $BOSH_PACKAGES_DIR/vsphere_cpi/bin/vsphere_cpi_post_start \
$BOSH_JOBS_DIR/vsphere_cpi/config/cpi.json